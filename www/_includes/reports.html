{% assign pytest = page.project | append: "-test" %}
{% for reports_data in site.data[pytest] %}
{% for report in reports_data %}
{% assign pytest_failed = pytest_failed | plus:report["summary"]["failed"] %}
{% assign pytest_count = pytest_count | plus:report["summary"]["num_tests"] %}
{% endfor %}
{% endfor %}

{% assign kibot = page.project | append: "_kibot_data" %}
{% for pcb in site.data[kibot] %}
  {% for report in pcb.reports %}
    {% if report.name == 'erc' %}
      {% for sheet in report.sheets %}
        {% assign _report_count = sheet.messages | size %}
        {% assign report_count = report_count | plus:_report_count %}
      {% endfor %}
    {% elsif report.name == 'drc' %}
      {% assign _report_count = report.messages | size %}
      {% assign report_count = report_count | plus:_report_count %}
    {% elsif report.name == 'unconnected' %}
      {% assign _report_count = report.messages | size %}
      {% assign report_count = report_count | plus:_report_count %}
    {% endif %}    
  {% endfor %}
{% endfor %}

{% if pytest_count > 0 %}
<div class="container is-large mt-1 mb-0">
    {% unless pytest_failed == 0 %}
    <div class="has-background-danger pl-2 pt-2 pb-2">
        <i class="fas fa-exclamation-circle has-text-white is-size-2"></i>
        <span class="has-text-white is-size-4">&nbsp;&nbsp;Found {{ pytest_failed }} error(s) in pytest check.</span>
    </div>
    <table class="table is-striped is-hoverable is-narrow mb-6">
        <col style="width:20%">
        <col style="width:10%">
        <col style="width:70%">
        {% for reports_data in site.data[pytest] %}
        {% for report in reports_data %}
        {% for test in report.tests %}
            <tr>
                <td>{{ test.name | regex_replace: 'tmp.*\.py::', '' }}</td>
                <td class="{% if test.outcome=='passed' %} is-success-dark {% else %} has-text-danger-dark {% endif %}">{{ test.outcome }}</td>
                {% assign report_rep = '-' %}
                {% if test.outcome == "failed" %}
                {% assign report_rep = test["call"]["longrepr"] %}
                {% assign report_rep = report_rep | regex_replace: '>', '&lt;' %}
                {% assign report_rep = report_rep | regex_replace: '<', '&gt;' %}
                {% assign report_rep = report_rep | regex_replace: '\n', '<br/>' %}
                {% endif %}
                <td>{{ report_rep }}</td>
            </tr>
        {% endfor %}
        {% endfor %}
        {% endfor %}
    </table>
    {% endunless %}
</div>
{% endif %}    

<div class="container is-large mt-1 mb-0">
    {% unless report_count == 0 %}
    {% for pcb in site.data[kibot] %}
        {% for report in pcb.reports %}

        {% if report.name == 'erc' %}
            {% for sheet in report.sheets %}
            {% assign erc_count = sheet.messages | size %}
            {% unless erc_count == 0 %}
            <div class="has-background-danger pl-2 pt-2 pb-2">
                <i class="fas fa-exclamation-circle has-text-white is-size-2"></i>
                <span class="has-text-white is-size-4">&nbsp;&nbsp;Found {{ sheet.messages | size }} errors in {{ report.name }} check.</span>
            </div>
            <table class="table is-striped is-hoverable is-narrow nb-6">
                <col style="width:20%">
                <col style="width:10%">
                <col style="width:70%">
                    {% for message in sheet.messages %}
                    <tr>
                        <td>{{ pcb.name }}</td>

                        <td>{{ message.message | strip_newlines }}</td>
                        <td>
                        {% for con in message.con %}
                            <p>{{ con.message | strip_newlines }}</p>
                        {% endfor %}
                        </td>
                    </tr>
                {% endfor %}
            </table>
            {% endunless %}
            {% endfor %}

        {% else %}
            {% assign report_count = report.messages | size %}
            {% unless report_count == 0 %}
            <div class="has-background-danger pl-2 pt-2 pb-2">
                <i class="fas fa-exclamation-circle has-text-white is-size-2"></i>
                <span class="has-text-white is-size-4">&nbsp;&nbsp;Found {{ report.messages | size }} errors in {{ report.name }} check.</span>
            </div>
            <table class="table is-striped is-hoverable is-narrow nb-6">
                <col style="width:20%">
                <col style="width:10%">
                <col style="width:70%">
                    {% for message in report.messages %}
                    <tr>
                        <td>{{ pcb.name }}</td>

                        <td>{{ message.message | strip_newlines }}</td>
                        <td>
                        {% for con in message.con %}
                            <p>{{ con.message | strip_newlines }}</p>
                        {% endfor %}
                        </td>
                    </tr>
                {% endfor %}
            </table>
            {% endunless %}
        {% endif %}
    {% endfor %}
    {% endfor %}
{% endunless %}
</div>


